<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: README
  
    &mdash; Documentation by YARD 0.9.5
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  pathId = "README";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="class_list.html"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: README</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <iframe id="search_frame" src="class_list.html"></iframe>

      <div id="content"><div id='filecontents'>
<h1 id="label-GeoEngineer">GeoEngineer</h1>

<p><a href="https://circleci.com/gh/coinbase/geoengineer"><img
src="https://circleci.com/gh/coinbase/geoengineer.svg?style=shield"></a></p>
<a href="https://commons.wikimedia.org/wiki/File:Mantle_of_Responsibility.png"><img src="./assets/mantle.png" align="right" alt="Mantle_of_Responsibility" /></a>
<p>GeoEngineer provides a Ruby DSL and command line tool (<code>geo</code>) to
<em>codify</em> then plan and execute changes to cloud resources.</p>

<p>GeoEngineer&#39;s goals/requirements/features are:</p>
<ol><li>
<p><strong>DSL based on Terraform</strong>: GeoEngineer uses <a
href="https://github.com/hashicorp/terraform">Terraform</a> to plan and
execute changes, so the DSL to describe resources is similar to
Terraform&#39;s. GeoEngineer&#39;s DSL also provides programming and object
oriented features like inheritance, abstraction, branching and looping.</p>
</li><li>
<p><strong>Development Workflow</strong>: GeoEngineer is built to be used
within existing development workflows, e.g. branching, creating pull
requests, code reviewing and merging. To simplify these workflows,
GeoEngineer dynamically generates Terraform state files using cloud APIs
and opinionated tagging.</p>
</li><li>
<p><strong>Extensible Validation</strong>: Every team has their own standards
when managing cloud resources e.g. naming patterns, tagging requirements,
security rules. GeoEngineer resources can have custom validations added to
ensure the resources conform to required standards.</p>
</li><li>
<p><strong>Reusable Templates</strong>: copy and pasting codified resources
makes it difficult to understand and maintain infrastructure. By
abstracting recommended patterns of reuse into <strong>templates</strong>,
GeoEngineer aims to increase code reuse and decrease code copy/paste.</p>
</li><li>
<p><strong>Describe Existing Resources</strong>: Existing resources can be
described with GeoEngineer without having to destroy and recreate them.</p>
</li><li>
<p><strong>Principle of Least Astonishment</strong>: show the exact plan
before execution; do nothing without confirmation; do not allow a plan to
be executed with failing validations; by default do not allow deletions;
show warnings and hints to make code better.</p>
</li><li>
<p><strong>One File per Project</strong>: Managing dozens of projects with
hundreds of files is difficult and error-prone, especially if a single
project&#39;s resources are described across many files. Projects are
easier to manage when they are each described in one file.</p>
</li><li>
<p><strong>Dependencies</strong>: resources have dependencies on other
resources, projects have dependencies on other projects. Using Ruby&#39;s
<code>require</code> file that describe resources can be included and
referenced without having to hard-code any values.</p>
</li></ol>

<h2 id="label-Getting+Started">Getting Started</h2>

<h3 id="label-Install+Terraform">Install Terraform</h3>

<p>Instructions to install Terraform can be found <a
href="https://www.terraform.io/downloads.html">here</a>.</p>

<h3 id="label-Install+Ruby">Install Ruby</h3>

<p>Instructions to install Ruby can be found <a
href="https://www.ruby-lang.org/en/documentation/installation/">here</a>.</p>

<h3 id="label-Install+GeoEngineer">Install GeoEngineer</h3>

<p>Secure install (this will validate the geoengineer gem):</p>

<pre class="code ruby"><code class="ruby">gem cert --add &lt;(curl -Ls https://raw.githubusercontent.com/coinbase/geoengineer/master/certs/geoengineer-gem.pem)
gem install geoengineer --trust-policy MediumSecurity</code></pre>

<p><em>Note: HighSecurity will not work because aws-sdk and other gems are not
signed</em></p>

<p>Or just install normally:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_gem'>gem</span> <span class='id identifier rubyid_install'>install</span> <span class='id identifier rubyid_geoengineer'>geoengineer</span>
</code></pre>

<p>Test it is installed correctly with:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_geo'>geo</span> <span class='op'>-</span><span class='op'>-</span><span class='id identifier rubyid_help'>help</span>
</code></pre>

<h3 id="label-First+GeoEngineer+Project">First GeoEngineer Project</h3>

<p>GeoEngineer can use the folder structure where projects and environments
are in the <code>projects</code> and <code>environments</code> directories
respectively, however everything can also be defined in a single file, e.g.
<code>first_project.rb</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># First define the environment which is available with the variable `env`
</span><span class='comment'># This is where project invariants are stored, e.g. subnets, vpc ...
</span><span class='id identifier rubyid_environment'>environment</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>staging</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span>
  <span class='id identifier rubyid_account_id'>account_id</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>1</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_subnet'>subnet</span>      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>1</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_vpc_id'>vpc_id</span>      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>1</span><span class='tstring_end'>&quot;</span></span>
<span class='rbrace'>}</span>

<span class='comment'># Create the first_project to be in the `staging` environment
</span><span class='id identifier rubyid_project'>project</span> <span class='op'>=</span> <span class='id identifier rubyid_project'>project</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>org</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>first_project</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span>
  <span class='id identifier rubyid_environments'>environments</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>staging</span><span class='tstring_end'>&#39;</span></span>
<span class='rbrace'>}</span>

<span class='comment'># Define the security group for the ELB to allow HTTP
</span><span class='id identifier rubyid_elb_sg'>elb_sg</span> <span class='op'>=</span> <span class='id identifier rubyid_project'>project</span><span class='period'>.</span><span class='id identifier rubyid_resource'>resource</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>aws_security_group</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>allow_http</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span>
  <span class='id identifier rubyid_name'>name</span>         <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>allow_http</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_description'>description</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Allow All HTTP</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_vpc_id'>vpc_id</span>       <span class='id identifier rubyid_env'>env</span><span class='period'>.</span><span class='id identifier rubyid_vpc_id'>vpc_id</span>
  <span class='id identifier rubyid_ingress'>ingress</span> <span class='lbrace'>{</span>
      <span class='id identifier rubyid_from_port'>from_port</span>    <span class='int'>80</span>
      <span class='id identifier rubyid_to_port'>to_port</span>      <span class='int'>80</span>
      <span class='id identifier rubyid_protocol'>protocol</span>     <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>tcp</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_cidr_blocks'>cidr_blocks</span>  <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>0.0.0.0/0</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
  <span class='rbrace'>}</span>
  <span class='id identifier rubyid_tags'>tags</span> <span class='lbrace'>{</span>
    <span class='const'>Name</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>allow_http</span><span class='tstring_end'>&quot;</span></span>
  <span class='rbrace'>}</span>
<span class='rbrace'>}</span>

<span class='comment'># Define the security group for EC2 to allow ingress from the ELB
</span><span class='id identifier rubyid_ec2_sg'>ec2_sg</span> <span class='op'>=</span> <span class='id identifier rubyid_project'>project</span><span class='period'>.</span><span class='id identifier rubyid_resource'>resource</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>aws_security_group</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>allow_elb</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span>
  <span class='id identifier rubyid_name'>name</span>         <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>allow_elb</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_description'>description</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Allow ELB to 80</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_vpc_id'>vpc_id</span>       <span class='id identifier rubyid_env'>env</span><span class='period'>.</span><span class='id identifier rubyid_vpc_id'>vpc_id</span>
  <span class='id identifier rubyid_ingress'>ingress</span> <span class='lbrace'>{</span>
      <span class='id identifier rubyid_from_port'>from_port</span>    <span class='int'>8000</span>
      <span class='id identifier rubyid_to_port'>to_port</span>      <span class='int'>8000</span>
      <span class='id identifier rubyid_protocol'>protocol</span>     <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>tcp</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_security_groups'>security_groups</span>  <span class='lbracket'>[</span><span class='id identifier rubyid_elb_sg'>elb_sg</span><span class='rbracket'>]</span>
  <span class='rbrace'>}</span>
  <span class='id identifier rubyid_tags'>tags</span> <span class='lbrace'>{</span>
    <span class='const'>Name</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>allow_elb</span><span class='tstring_end'>&quot;</span></span>
  <span class='rbrace'>}</span>
<span class='rbrace'>}</span>

<span class='comment'># cloud_config to run webserver
</span><span class='id identifier rubyid_user_data'>user_data</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>%{</span><span class='tstring_content'>
#cloud-config
runcmd:
  - docker run -d --name nginx -p 8000:80 nginx
</span><span class='tstring_end'>}</span></span>

<span class='comment'># Create an EC2 instance to run nginx server
</span><span class='id identifier rubyid_instance'>instance</span> <span class='op'>=</span> <span class='id identifier rubyid_project'>project</span><span class='period'>.</span><span class='id identifier rubyid_resource'>resource</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>aws_instance</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>web</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span>
  <span class='id identifier rubyid_ami'>ami</span>           <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ami-1c94e10b</span><span class='tstring_end'>&quot;</span></span> <span class='comment'># COREOS AMI
</span>  <span class='id identifier rubyid_instance_type'>instance_type</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>t1.micro</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_subnet_id'>subnet_id</span>     <span class='id identifier rubyid_env'>env</span><span class='period'>.</span><span class='id identifier rubyid_subnet'>subnet</span>
  <span class='id identifier rubyid_user_data'>user_data</span>     <span class='id identifier rubyid_user_data'>user_data</span>
  <span class='id identifier rubyid_tags'>tags</span> <span class='lbrace'>{</span>
    <span class='const'>Name</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ec2_instance</span><span class='tstring_end'>&quot;</span></span>
  <span class='rbrace'>}</span>
<span class='rbrace'>}</span>

<span class='comment'># Create the ELB connected to the instance
</span><span class='id identifier rubyid_project'>project</span><span class='period'>.</span><span class='id identifier rubyid_resource'>resource</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>aws_elb</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>main-web-app</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span>
  <span class='id identifier rubyid_name'>name</span>             <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>main-app-elb</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_security_groups'>security_groups</span>  <span class='lbracket'>[</span><span class='id identifier rubyid_elb_sg'>elb_sg</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_subnets'>subnets</span>          <span class='lbracket'>[</span><span class='id identifier rubyid_env'>env</span><span class='period'>.</span><span class='id identifier rubyid_subnet'>subnet</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_instances'>instances</span>        <span class='lbracket'>[</span><span class='id identifier rubyid_instance'>instance</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_listener'>listener</span> <span class='lbrace'>{</span>
    <span class='id identifier rubyid_instance_port'>instance_port</span>     <span class='int'>8000</span>
    <span class='id identifier rubyid_instance_protocol'>instance_protocol</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_lb_port'>lb_port</span>           <span class='int'>80</span>
    <span class='id identifier rubyid_lb_protocol'>lb_protocol</span>       <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http</span><span class='tstring_end'>&quot;</span></span>
  <span class='rbrace'>}</span>
<span class='rbrace'>}</span>
</code></pre>

<p>GeoEngineer command line tool <code>geo</code> can:</p>
<ol><li>
<p><strong>Create a plan</strong> with <code>geo plan -e staging
first_project.rb</code></p>
</li><li>
<p><strong>Execute the plan</strong> with <code>geo apply -e staging
first_project.rb</code></p>
</li><li>
<p><strong>Create a graph</strong> with <code>geo graph -e staging --quiet
first_project.rb | dot -Tpng &gt; graph.png &amp;&amp; open
graph.png</code></p>
</li><li>
<p><strong>Status of Codeified Resources</strong> with <code>geo status
first_project.rb -e staging</code></p>
</li></ol>

<p><em>There are more examples in the <code>examples</code> folder.</em></p>

<h2 id="label-Customizations">Customizations</h2>

<p>A core benefit of GeoEngineer is the ability to customize the DSL to your
needs using custom validations, templates and reusable methods on
resources.</p>

<h3 id="label-Validations">Validations</h3>

<p>Below is an example which will add the validation to ensure that all
listeners on all ELB&#39;s must be HTTPS, for security reasons.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>GeoEngineer</span><span class='op'>::</span><span class='const'>Resources</span><span class='op'>::</span><span class='const'>AwsElb</span> <span class='op'>&lt;</span> <span class='const'>GeoEngineer</span><span class='op'>::</span><span class='const'>Resource</span>
  <span class='id identifier rubyid_validate'>validate</span> <span class='symbol'>:validate_listeners_must_be_https</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_validate_listeners_must_be_https'>validate_listeners_must_be_https</span>
    <span class='id identifier rubyid_errors'>errors</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_all_listener'>all_listener</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span> <span class='id identifier rubyid_i'>i</span><span class='period'>.</span><span class='id identifier rubyid_lb_protocol'>lb_protocol</span> <span class='op'>!=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>https</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span>
      <span class='id identifier rubyid_errors'>errors</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ELB must use https protocol </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_for_resource'>for_resource</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_errors'>errors</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<h3 id="label-Templates">Templates</h3>

<p>Below is an example template that builds a Elastic Load Balancer and a
security group for an array of listeners:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>LoadBalancedInstance</span> <span class='op'>&lt;</span> <span class='const'>Template</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:elb</span><span class='comma'>,</span> <span class='symbol'>:elb_sg</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_project'>project</span><span class='comma'>,</span> <span class='id identifier rubyid_parameters'>parameters</span><span class='rparen'>)</span>
    <span class='kw'>super</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_project'>project</span><span class='comma'>,</span> <span class='id identifier rubyid_parameters'>parameters</span><span class='rparen'>)</span>
    <span class='comment'># { listeners: [{ in: out: }]}
</span>    <span class='id identifier rubyid_listeners'>listeners</span> <span class='op'>=</span> <span class='id identifier rubyid_parameters'>parameters</span><span class='lbracket'>[</span><span class='symbol'>:listeners</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>

    <span class='comment'># Create the Security Groups
</span>    <span class='id identifier rubyid_elb_sg'>elb_sg</span> <span class='op'>=</span> <span class='id identifier rubyid_resource'>resource</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>aws_security_group</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'>_allow_http</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span>
      <span class='id identifier rubyid_name'>name</span>         <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'>_elb_sg</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_description'>description</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_vpc_id'>vpc_id</span>       <span class='id identifier rubyid_env'>env</span><span class='period'>.</span><span class='id identifier rubyid_vpc_id'>vpc_id</span>
      <span class='kw'>for</span> <span class='id identifier rubyid_l'>l</span> <span class='kw'>in</span> <span class='id identifier rubyid_listeners'>listeners</span>
        <span class='id identifier rubyid_ingress'>ingress</span> <span class='lbrace'>{</span>
          <span class='id identifier rubyid_from_port'>from_port</span>    <span class='id identifier rubyid_l'>l</span><span class='lbracket'>[</span><span class='symbol'>:in</span><span class='rbracket'>]</span>
          <span class='id identifier rubyid_to_port'>to_port</span>      <span class='id identifier rubyid_l'>l</span><span class='lbracket'>[</span><span class='symbol'>:in</span><span class='rbracket'>]</span>
          <span class='id identifier rubyid_protocol'>protocol</span>     <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>tcp</span><span class='tstring_end'>&quot;</span></span>
          <span class='id identifier rubyid_cidr_blocks'>cidr_blocks</span>  <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>0.0.0.0/0</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
        <span class='rbrace'>}</span>
      <span class='kw'>end</span>
      <span class='id identifier rubyid_tags'>tags</span> <span class='lbrace'>{</span> <span class='const'>Name</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'>_elb_sg</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
    <span class='rbrace'>}</span>

    <span class='comment'># ELB
</span>    <span class='id identifier rubyid_elb'>elb</span> <span class='op'>=</span> <span class='id identifier rubyid_resource'>resource</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>aws_elb</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>main-web-app</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span>
      <span class='id identifier rubyid_name'>name</span>             <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'>_elb</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_security_groups'>security_groups</span>  <span class='lbracket'>[</span><span class='id identifier rubyid_elb_sg'>elb_sg</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_subnets'>subnets</span>          <span class='lbracket'>[</span><span class='id identifier rubyid_env'>env</span><span class='period'>.</span><span class='id identifier rubyid_subnet'>subnet</span><span class='rbracket'>]</span>
      <span class='kw'>for</span> <span class='id identifier rubyid_l'>l</span> <span class='kw'>in</span> <span class='id identifier rubyid_listeners'>listeners</span>
        <span class='id identifier rubyid_listener'>listener</span> <span class='lbrace'>{</span>
          <span class='id identifier rubyid_instance_port'>instance_port</span>     <span class='id identifier rubyid_l'>l</span><span class='lbracket'>[</span><span class='symbol'>:out</span><span class='rbracket'>]</span>
          <span class='id identifier rubyid_instance_protocol'>instance_protocol</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http</span><span class='tstring_end'>&quot;</span></span>
          <span class='id identifier rubyid_lb_port'>lb_port</span>           <span class='id identifier rubyid_l'>l</span><span class='lbracket'>[</span><span class='symbol'>:in</span><span class='rbracket'>]</span>
          <span class='id identifier rubyid_lb_protocol'>lb_protocol</span>       <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>http</span><span class='tstring_end'>&quot;</span></span>
        <span class='rbrace'>}</span>
      <span class='kw'>end</span>
    <span class='rbrace'>}</span>

    <span class='ivar'>@elb</span>    <span class='op'>=</span> <span class='id identifier rubyid_elb'>elb</span>
    <span class='ivar'>@elb_sg</span> <span class='op'>=</span> <span class='id identifier rubyid_elb_sg'>elb_sg</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_template_resources'>template_resources</span>
    <span class='lbracket'>[</span><span class='ivar'>@elb</span><span class='comma'>,</span> <span class='ivar'>@elb_sg</span><span class='rbracket'>]</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='comment'># Instantiate the template for this project to forward two ports 80 and 8080
</span><span class='id identifier rubyid_project'>project</span><span class='period'>.</span><span class='id identifier rubyid_from_template'>from_template</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>load_balanced_instance</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>main_app</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='lbrace'>{</span>
  <span class='label'>listeners:</span> <span class='lbracket'>[</span><span class='lbrace'>{</span><span class='label'>in:</span> <span class='int'>80</span><span class='comma'>,</span> <span class='label'>out:</span> <span class='int'>3000</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='label'>in:</span> <span class='int'>8080</span><span class='comma'>,</span> <span class='label'>out:</span> <span class='int'>4000</span> <span class='rbrace'>}</span><span class='rbracket'>]</span>
<span class='rbrace'>}</span><span class='rparen'>)</span>
</code></pre>

<h3 id="label-Methods">Methods</h3>

<p>Define methods to be used in your own resources, e.g. a custom method to
security group to add a rule:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>GeoEngineer</span><span class='op'>::</span><span class='const'>Resources</span><span class='op'>::</span><span class='const'>AwsSecurityGroup</span> <span class='op'>&lt;</span> <span class='const'>GeoEngineer</span><span class='op'>::</span><span class='const'>Resource</span>
  <span class='comment'># ...
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_all_egress_everywhere'>all_egress_everywhere</span>
    <span class='id identifier rubyid_egress'>egress</span> <span class='lbrace'>{</span>
        <span class='id identifier rubyid_from_port'>from_port</span>        <span class='int'>0</span>
        <span class='id identifier rubyid_to_port'>to_port</span>          <span class='int'>0</span>
        <span class='id identifier rubyid_protocol'>protocol</span>         <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-1</span><span class='tstring_end'>&quot;</span></span>
        <span class='id identifier rubyid_cidr_blocks'>cidr_blocks</span>      <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>0.0.0.0/0</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
    <span class='rbrace'>}</span>
  <span class='kw'>end</span>
  <span class='comment'># ...
</span><span class='kw'>end</span>

<span class='id identifier rubyid_project'>project</span><span class='period'>.</span><span class='id identifier rubyid_resource'>resource</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>aws_security_group</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>all_egress</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span>
  <span class='id identifier rubyid_all_egress_everywhere'>all_egress_everywhere</span> <span class='comment'># use the method to add egress
</span><span class='rbrace'>}</span>
</code></pre>

<h2 id="label-Adding+New+Resources">Adding New Resources</h2>

<p>The best way to contribute is to add resources that exist in Terraform but
are not yet described in GeoEngineer.</p>

<p>To define a resource:</p>
<ol><li>
<p>checkout and fork/branch GeoEngineer</p>
</li><li>
<p>create a file
<code>./lib/geoengineer/resources/&lt;resource_type&gt;.rb</code></p>
</li><li>
<p>define a class <code>class GeoEngineer::Resources::&lt;ResourceType&gt;
&lt; GeoEngineer::Resource</code></p>
</li><li>
<p>define <code>_terraform_id</code>, and potentially <code>_geo_id</code> and
<code>self._fetch_remote_resources</code> method (more below).</p>
</li><li>
<p>write a test file for the resource that follows the style of other similar
resources</p>
</li></ol>

<h3 id="label-Codeified+to+Remote+Resources">Codeified to Remote Resources</h3>

<p>A fundamental problem with codifying resources is matching the in code
resource to the real remote resource. Terraform does this by maintaining an
<code>id</code> in a state file which is matched to a remote resources
attribute. This attribute is different per resource, e.g. for ELB&#39;s it
is their <code>name</code>, for security groups it is their
<code>group_name</code> that is generated so cannot be codified.</p>

<p>Without a state file GeoEngineer uses API&#39;s to match resources, this
makes generated <code>id</code>&#39;s likes security groups difficult. For
these generated ids GeoEngineer uses tags e.g. for ELB&#39;s the
GeoEngineer id is its <code>name</code> (just like Terraform) and for
security groups it is their <code>Name</code> tag.</p>

<p>In a GeoEngineer resource the <code>_terraform_id</code> is the id used by
Terraform and the <code>_geo_id</code> is GeoEngineer ID. By default a
resources <code>_geo_id</code> is the same as the
<code>_terraform_id</code>, so for most resources only the
<code>_terraform_id</code> is required.</p>

<p>If <code>_terraform_id</code> is generated then the remote resource needed
to be fetched via API and matched to the codified resource with
<code>_geo_id</code>. This is done by implementing the
<code>self._fetch_remote_resources</code> method to use the API and return
a list of resources with both <code>_terraform_id</code> and
<code>_geo_id</code>, then GeoEngineer can match them.</p>

<p>For example, in <code>aws_security_group</code>&#39;s the resource is
matched based on the <code>Name</code> tag, implements as:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>GeoEngineer</span><span class='op'>::</span><span class='const'>Resources</span><span class='op'>::</span><span class='const'>AwsSecurityGroup</span> <span class='op'>&lt;</span> <span class='const'>GeoEngineer</span><span class='op'>::</span><span class='const'>Resource</span>
  <span class='id identifier rubyid_after'>after</span> <span class='symbol'>:initialize</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid__terraform_id'>_terraform_id</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='const'>NullObject</span><span class='period'>.</span><span class='id identifier rubyid_maybe'>maybe</span><span class='lparen'>(</span><span class='id identifier rubyid_remote_resource'>remote_resource</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid__terraform_id'>_terraform_id</span> <span class='rbrace'>}</span> <span class='rbrace'>}</span>
  <span class='id identifier rubyid_after'>after</span> <span class='symbol'>:initialize</span><span class='comma'>,</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid__geo_id'>_geo_id</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='const'>NullObject</span><span class='period'>.</span><span class='id identifier rubyid_maybe'>maybe</span><span class='lparen'>(</span><span class='id identifier rubyid_tags'>tags</span><span class='rparen'>)</span><span class='lbracket'>[</span><span class='symbol'>:Name</span><span class='rbracket'>]</span> <span class='rbrace'>}</span> <span class='rbrace'>}</span>

  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid__fetch_remote_resources'>_fetch_remote_resources</span><span class='lparen'>(</span><span class='id identifier rubyid_provider'>provider</span><span class='rparen'>)</span>
    <span class='const'>AwsClients</span><span class='period'>.</span><span class='id identifier rubyid_ec2'>ec2</span><span class='lparen'>(</span><span class='id identifier rubyid_provider'>provider</span><span class='rparen'>)</span>
      <span class='period'>.</span><span class='id identifier rubyid_describe_security_groups'>describe_security_groups</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>security_groups</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
      <span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:to_h</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_sg'>sg</span><span class='op'>|</span>
        <span class='id identifier rubyid_sg'>sg</span><span class='lbracket'>[</span><span class='symbol'>:name</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_sg'>sg</span><span class='lbracket'>[</span><span class='symbol'>:group_name</span><span class='rbracket'>]</span>
        <span class='id identifier rubyid_sg'>sg</span><span class='lbracket'>[</span><span class='symbol'>:_terraform_id</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_sg'>sg</span><span class='lbracket'>[</span><span class='symbol'>:group_id</span><span class='rbracket'>]</span>
        <span class='id identifier rubyid_sg'>sg</span><span class='lbracket'>[</span><span class='symbol'>:_geo_id</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_sg'>sg</span><span class='lbracket'>[</span><span class='symbol'>:tags</span><span class='rbracket'>]</span> <span class='op'>?</span> <span class='id identifier rubyid_sg'>sg</span><span class='lbracket'>[</span><span class='symbol'>:tags</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_x'>x</span><span class='op'>|</span> <span class='id identifier rubyid_x'>x</span><span class='lbracket'>[</span><span class='symbol'>:key</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Name</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='lbracket'>[</span><span class='symbol'>:value</span><span class='rbracket'>]</span> <span class='op'>:</span> <span class='kw'>nil</span>
        <span class='id identifier rubyid_sg'>sg</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<h3 id="label-Validations">Validations</h3>

<p>Terraform does not validate a lot of attributes before they are sent to the
cloud. This means that often plans will fail for reasons that could have
been initially validated. When creating a resource think about what
validations could be done to ensure a plan is successful.</p>

<p>For example, a security groups needs a <code>Name</code> tag, requires a
<code>name</code> and <code>description</code>, and a more complicated
example is that its <code>cidr_blocks</code> should be valid:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>GeoEngineer</span><span class='op'>::</span><span class='const'>Resources</span><span class='op'>::</span><span class='const'>AwsSecurityGroup</span> <span class='op'>&lt;</span> <span class='const'>GeoEngineer</span><span class='op'>::</span><span class='const'>Resource</span>
  <span class='comment'># ...
</span>  <span class='id identifier rubyid_validate'>validate</span> <span class='symbol'>:validate_correct_cidr_blocks</span>
  <span class='id identifier rubyid_validate'>validate</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_validate_required_attributes'>validate_required_attributes</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='symbol'>:name</span><span class='comma'>,</span> <span class='symbol'>:description</span><span class='rbracket'>]</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
  <span class='id identifier rubyid_validate'>validate</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_validate_has_tag'>validate_has_tag</span><span class='lparen'>(</span><span class='symbol'>:Name</span><span class='rparen'>)</span> <span class='rbrace'>}</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_validate_correct_cidr_blocks'>validate_correct_cidr_blocks</span>
    <span class='id identifier rubyid_errors'>errors</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
    <span class='lparen'>(</span><span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_all_ingress'>all_ingress</span> <span class='op'>+</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_all_egress'>all_egress</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_in_eg'>in_eg</span><span class='op'>|</span>
      <span class='kw'>next</span> <span class='kw'>unless</span> <span class='id identifier rubyid_in_eg'>in_eg</span><span class='period'>.</span><span class='id identifier rubyid_cidr_blocks'>cidr_blocks</span>
      <span class='id identifier rubyid_in_eg'>in_eg</span><span class='period'>.</span><span class='id identifier rubyid_cidr_blocks'>cidr_blocks</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_cidr'>cidr</span><span class='op'>|</span>
        <span class='kw'>begin</span>
          <span class='const'>NetAddr</span><span class='op'>::</span><span class='const'>CIDR</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span><span class='id identifier rubyid_cidr'>cidr</span><span class='rparen'>)</span>
        <span class='kw'>rescue</span> <span class='const'>NetAddr</span><span class='op'>::</span><span class='const'>ValidationError</span>
          <span class='id identifier rubyid_errors'>errors</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Bad cidr block \&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_cidr'>cidr</span><span class='embexpr_end'>}</span><span class='tstring_content'>\&quot; </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_for_resource'>for_resource</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_errors'>errors</span>
  <span class='kw'>end</span>
  <span class='comment'># ...
</span><span class='kw'>end</span>
</code></pre>

<h3 id="label-Terraform+State">Terraform State</h3>

<p>Terraform by default will attempt to sync its resources with the API so
that its state file is up to date with the real world. Given that
GeoEngineer uses Terraform in a different way this sometimes causes plans
to list changes that have already happened.</p>

<p>To fix this issue a resource can override <code>to_terraform_state</code>
method, e.g. <code>aws_db_instance</code> has issues with
<code>final_snapshot_identifier</code> updating:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>GeoEngineer</span><span class='op'>::</span><span class='const'>Resources</span><span class='op'>::</span><span class='const'>AwsDbInstance</span> <span class='op'>&lt;</span> <span class='const'>GeoEngineer</span><span class='op'>::</span><span class='const'>Resource</span>
  <span class='comment'># ...
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_terraform_state'>to_terraform_state</span>
    <span class='id identifier rubyid_tfstate'>tfstate</span> <span class='op'>=</span> <span class='kw'>super</span>
    <span class='id identifier rubyid_tfstate'>tfstate</span><span class='lbracket'>[</span><span class='symbol'>:primary</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:attributes</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbrace'>{</span>
      <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>final_snapshot_identifier</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_final_snapshot_identifier'>final_snapshot_identifier</span><span class='comma'>,</span>
    <span class='rbrace'>}</span>
    <span class='id identifier rubyid_tfstate'>tfstate</span>
  <span class='kw'>end</span>
  <span class='comment'># ...
</span><span class='kw'>end</span>
</code></pre>

<h2 id="label-GeoEngineer+Reference">GeoEngineer Reference</h2>

<p>The core models in GeoEngineer are:</p>

<pre class="code ruby"><code class="ruby">+-------------+ 1
 | Environment +-----------+
 +-------------+           |
       | 1                 |
       |                   |
       v *                 v *
 +-----+-------+ 1  * +-------------+ 1  *  +-------------+
 | Project     +-----&gt;+ Resource    +------&gt;+ SubResource |
 +-------------+      +-------------+       +-------------+
       | 1                 ^ *
       |                   |
       v *                 |
 +-------------+           |
 | Template    +-----------+
 +-------------+ 1</code></pre>
<ol><li>
<p><code>Environment</code> contains many resources that may exist outside of
a project, like VPCs or routing tables. Also every project defined to be in
the environment, for example the <code>test_www</code> project is in
<code>staging</code> but <code>monorail</code> is in <code>staging</code>
and <code>production</code> environments.</p>
</li><li>
<p><code>Project</code> contains many resources and services grouped together
into a name.</p>
</li><li>
<p><code>Template</code> has a <code>type</code> and <code>name</code>, and a
group of resources that are defined in a pattern, e.g. every Load Balancer
requires a unique security group that allows traffic in. It is a simple
abstraction that can dramatically simplify and standardize cloud resources.</p>
</li><li>
<p><code>Resource</code> and <code>SubResource</code> are based off of how
terraform models cloud resources. A <code>Resource</code> instance can have
many <code>SubResource</code> instances, but a <code>SubResource</code>
instance belongs to only one <code>Resource</code> instance, e.g. a load
balancer resource may have a <code>health_check</code> sub-resource to only
allow specific incoming ports.</p>
</li></ol>

<p>All these models can have arbitrary attributes assigned to them either by
directly assigning on the instance, or through passing a block to the
constructor. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_resource'>resource</span> <span class='op'>=</span> <span class='const'>Resource</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>type</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>id</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_res'>res</span><span class='op'>|</span>
  <span class='comment'># CORRECT
</span>  <span class='id identifier rubyid_res'>res</span><span class='period'>.</span><span class='id identifier rubyid_hello'>hello</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>hey</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_res'>res</span><span class='period'>.</span><span class='id identifier rubyid_hello'>hello</span> <span class='comment'># &#39;hey&#39;
</span>  <span class='id identifier rubyid_hello'>hello</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>hey again</span><span class='tstring_end'>&#39;</span></span> <span class='comment'>#
</span>  <span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_res'>res</span><span class='period'>.</span><span class='id identifier rubyid_hello'>hello</span> <span class='comment'># &#39;hey again&#39;
</span>
  <span class='comment'># INCORRECT way of assigning variables
</span>  <span class='id identifier rubyid_goodbye'>goodbye</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>nooo</span><span class='tstring_end'>&#39;</span></span> <span class='comment'># This assigns a local variable, not an attribute on the resource
</span>  <span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_res'>res</span><span class='period'>.</span><span class='id identifier rubyid_goodbye'>goodbye</span> <span class='comment'># nil
</span><span class='rbrace'>}</span>

<span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_resource'>resource</span><span class='period'>.</span><span class='id identifier rubyid_hello'>hello</span> <span class='comment'># &#39;hey again&#39;
</span>
<span class='id identifier rubyid_resource'>resource</span><span class='period'>.</span><span class='id identifier rubyid_goodbye'>goodbye</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>see ya</span><span class='tstring_end'>&#39;</span></span>
<span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_resource'>resource</span><span class='period'>.</span><span class='id identifier rubyid_goodbye'>goodbye</span> <span class='comment'># &#39;see ya&#39;
</span></code></pre>

<p>Additionally, if the value is expensive to calculate or requires other
attributes not yet assigned, an attribute can be assigned a
<code>Proc</code> or <code>lambda</code> which will be calculated lazily:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_resource'>resource</span> <span class='op'>=</span> <span class='const'>Resource</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>type</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>id</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
<span class='id identifier rubyid_resource'>resource</span><span class='period'>.</span><span class='id identifier rubyid_lazy_attr'>lazy_attr</span> <span class='op'>=</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CALCULATING THE VALUE</span><span class='tstring_end'>&quot;</span></span><span class='semicolon'>;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>value</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span>
<span class='comment'># ...
</span><span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_resource'>resource</span><span class='period'>.</span><span class='id identifier rubyid_lazy_attr'>lazy_attr</span>
<span class='comment'>#$ &quot;CALCULATING THE VALUE&quot;
</span><span class='comment'>#$ &quot;value&quot;
</span></code></pre>

<h3 id="label-Environment">Environment</h3>

<p>The top level class in GeoEngineer is the <code>environment</code>: it
contains all projects, resources and services, and there should only ever
be one initialized at a time.</p>

<p>An environment can mean many things to different people, e.g. an AWS
account, an AWS region, or a specific AWS VPC. The only real constraint is
that a resource has one instance per environment, e.g. a load balancer that
is defined to be in <code>staging</code> and <code>production</code>
environments, will have an instance in each.</p>

<p>The function <code>environment</code> is provided as a factory to build an
environment:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_environment'>environment</span> <span class='op'>=</span> <span class='id identifier rubyid_environment'>environment</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>environment_name</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_e'>e</span><span class='op'>|</span>
  <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_attr_1'>attr_1</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='int'>1</span><span class='comma'>,</span><span class='int'>2</span><span class='comma'>,</span><span class='int'>3</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_attr_2'>attr_2</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>value</span><span class='tstring_end'>&#39;</span></span>
<span class='rbrace'>}</span>
<span class='id identifier rubyid_environment'>environment</span><span class='period'>.</span><span class='id identifier rubyid_attr_3'>attr_3</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>another value</span><span class='tstring_end'>&quot;</span></span>
</code></pre>

<h3 id="label-Project">Project</h3>

<p>A project is a group of resources typically provisioned to deploy one code
base. A project has an <code>organization</code> and <code>name</code>, to
mimic the github <code>username</code>/<code>organiztion</code> and
<code>repository</code> structure.</p>

<p>A project is defined like:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_project'>project</span> <span class='op'>=</span> <span class='id identifier rubyid_project'>project</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>org</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>project_name</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span>
  <span class='id identifier rubyid_environments'>environments</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>staging</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>production</span><span class='tstring_end'>&#39;</span></span>
<span class='rbrace'>}</span>
</code></pre>

<p>This projects organization is <code>org</code>, its name
<code>project_name</code> and will be provisioned in the
<code>staging</code> and <code>production</code> environments. The
<code>org</code> and <code>name</code> must be unique across all other
projects.</p>

<p>The method <code>project</code> will automatically add the project to the
instantiated environment object <strong>only if</strong> that
environment&#39;s name is in the list of environments, otherwise it is
ignored.</p>

<h3 id="label-Templates">Templates</h3>

<p>A template is used to create a group of resources in a recommended pattern.
For example, an HTTP service could create a load balancer, a load balancer
security group, and a ec2 security group.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_template_instance'>template_instance</span> <span class='op'>=</span> <span class='id identifier rubyid_project'>project</span><span class='period'>.</span><span class='id identifier rubyid_from_template'>from_template</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>template_type</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>name</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>parameter:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>helloworld</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_resource'>resource</span><span class='comma'>,</span> <span class='id identifier rubyid_resource_sg'>resource_sg</span><span class='op'>|</span>

  <span class='comment'># set attribute
</span>  <span class='id identifier rubyid_attribute'>attribute</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>custom attribute</span><span class='tstring_end'>&quot;</span></span>

  <span class='comment'># Customize the values
</span>  <span class='id identifier rubyid_resource'>resource</span><span class='period'>.</span><span class='id identifier rubyid_cutomize_value'>cutomize_value</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Customize</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_resource'>resource</span><span class='period'>.</span><span class='id identifier rubyid_override_value'>override_value</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Override</span><span class='tstring_end'>&quot;</span></span>

  <span class='comment'># Overrider a subresource value
</span>  <span class='id identifier rubyid_resource'>resource</span><span class='period'>.</span><span class='id identifier rubyid_subresource'>subresource</span><span class='period'>.</span><span class='id identifier rubyid_override_sr_value'>override_sr_value</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>first value</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_resource'>resource</span><span class='period'>.</span><span class='id identifier rubyid_all_subresource'>all_subresource</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_override_sr_value'>override_sr_value</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>new value</span><span class='tstring_end'>&quot;</span></span>
<span class='rbrace'>}</span>

<span class='id identifier rubyid_template_instance'>template_instance</span><span class='period'>.</span><span class='id identifier rubyid_resource_sg'>resource_sg</span> <span class='comment'># access the created resources outside the block
</span></code></pre>

<p>This template will create a resource <code>resource</code> and a resource
security group <code>resource_sg</code> with the option <code>hello</code>
set to value <code>&#39;world&#39;</code>. The resources can then be
customized and have their values overridden.</p>

<p>Each template should be documented with the created resources and how to
modify them.</p>

<h3 id="label-Resources+and+SubResources">Resources and SubResources</h3>

<p>Resources are defined to be similar to the <a
href="https://www.terraform.io/docs/configuration/resources.html">terraform
resource</a> configuration. The main difference is to not use
<code>=</code> as this will create a local ruby variable and not assign the
value.</p>

<p>A <code>Resource</code> can be created with and <code>environment</code>,
<code>project</code> or <code>template</code> object (this will add that
resource to that object):</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_environment'>environment</span><span class='period'>.</span><span class='id identifier rubyid_resource'>resource</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>type</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>identifier</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span>
  <span class='id identifier rubyid_name'>name</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>resource_name</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_subresource'>subresource</span> <span class='lbrace'>{</span>
    <span class='id identifier rubyid_attribute'>attribute</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>attribute</span><span class='tstring_end'>&quot;</span></span>
  <span class='rbrace'>}</span>
<span class='rbrace'>}</span>

<span class='id identifier rubyid_project'>project</span><span class='period'>.</span><span class='id identifier rubyid_resource'>resource</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>type</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>identifier</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span>
  <span class='comment'># ...
</span><span class='rbrace'>}</span>

<span class='id identifier rubyid_template'>template</span><span class='period'>.</span><span class='id identifier rubyid_resource'>resource</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>type</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>identifier</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span>
  <span class='comment'># ...
</span><span class='rbrace'>}</span>
</code></pre>

<p>The <code>type</code> of a resource must be a valid terraform type, where
AWS types are listed <a
href="https://www.terraform.io/docs/providers/aws/index.html">here</a>.
Some resources are not supported yet by GeoEngineer.</p>

<p><code>identifier</code> is used by GeoEngineer and terraform to reference
this resource must be unique, however it is not stored in the cloud so can
be changed without affecting a plan.</p>

<p>A resource also has a ruby block sent to it that contains parameters and
sub-resources. These values are defined by terraform so for reference to
what values are required please refer to the <a
href="https://www.terraform.io/docs/providers/aws/index.html">terraform
docs</a>.</p>
</div></div>

      <div id="footer">
  Generated on Thu May 18 10:24:31 2017 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.5 (ruby-2.4.1).
</div>

    </div>
  </body>
</html>